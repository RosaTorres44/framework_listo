name: DataOps Pipeline â€“ Bronze to Silver

on:
  workflow_dispatch: {}
  push:
    branches: ["main"]
    paths:
      - "data/**"
      - "framework/**"
      - ".github/workflows/dataops-pipeline.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: |
          python -m pip install --upgrade pip
          pip install databricks-sql-connector
      - name: Deploy tables/schemas
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_HTTP_PATH: ${{ secrets.DATABRICKS_HTTP_PATH }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          SQL_FILE: framework/deployment/deploy.sql
        run: |
          python framework/processing/run_sql.py

  bronze:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: |
          python -m pip install --upgrade pip
          pip install databricks-sql-connector
      - name: Ingest Bronze
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_HTTP_PATH: ${{ secrets.DATABRICKS_HTTP_PATH }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          CSV_PATH: data/source/customers.csv
          TARGET_TABLE: demo.bronze_customers
          SOURCE_NAME: github_actions
        run: |
          python framework/ingestion/ingest_bronze.py

  silver:
    runs-on: ubuntu-latest
    needs: bronze
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: |
          python -m pip install --upgrade pip
          pip install databricks-sql-connector
      - name: Load Silver
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_HTTP_PATH: ${{ secrets.DATABRICKS_HTTP_PATH }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          SQL_FILE: framework/processing/load_silver.sql
        run: |
          python framework/processing/run_sql.py

  validation:
    runs-on: ubuntu-latest
    needs: silver
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: |
          python -m pip install --upgrade pip
          pip install databricks-sql-connector
      - name: Validate Silver + write ops_dq_results
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_HTTP_PATH: ${{ secrets.DATABRICKS_HTTP_PATH }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          RUN_ID: ${{ github.run_id }}
        run: |
          python framework/validation/validate_silver.py

  tests:
    runs-on: ubuntu-latest
    needs: validation
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - name: Run dataset tests
        run: |
          python framework/tests/test_dataset.py
